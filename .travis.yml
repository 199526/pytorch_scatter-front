sudo: enabled

env:
  global:
    - TORCH_VERSION=1.4.0
  # jobs:
  #   - FORCE_CUDA=0 TORCH=${TORCH_VERSION}+cpu
  #   - FORCE_CUDA=1 CUDA_SHORT=9.2 CUDA=9.2.148-1 UBUNTU_VERSION=ubuntu1604 CUBLAS=cuda-cublas-dev-9-2 TORCH=${TORCH_VERSION}+cu92
    # - FORCE_CUDA=1 CUDA_SHORT=10.0 CUDA=10.0.130-1 UBUNTU_VERSION=ubuntu1804 CUBLAS=cuda-cublas-dev-10-0 TORCH=${TORCH_VERSION}+cu100

jobs:
  include:
    - name: linux/cpu
      os: linux
      language: python
      python: 3.7.6
      env:
        - IDX=cpu
        - TORCH=${TORCH_VERSION}+${IDX}
    - name: linux/cu92
      os: linux
      language: python
      python: 3.7.6
      env:
        - IDX=cu92
        - CUDA_SHORT=9.2
        - CUDA=9.2.148-1
        - UBUNTU_VERSION=ubuntu1604
        - CUBLAS=cuda-cublas-dev-9-2
        - TORCH=${TORCH_VERSION}+${IDX}
    - name: linux/cu100
      os: linux
      language: python
      python: 3.7.6
      env:
        - IDX=cu100
        - CUDA_SHORT=10.0
        - CUDA=10.0.130-1
        - UBUNTU_VERSION=ubuntu1804
        - CUBLAS=cuda-cublas-dev-10-0
        - TORCH=${TORCH_VERSION}+${IDX}
    - name: linux/cu101
      os: linux
      language: python
      python: 3.7.6
      env:
        - IDX=cu101
        - CUDA_SHORT=10.1
        - CUDA=10.1.105-1
        - UBUNTU_VERSION=ubuntu1804
        - CUBLAS=libcublas-dev
        - TORCH=${TORCH_VERSION}
    - name: macosx/cpu
      os: osx
      osx_image: xcode11.3
      language: shell
      env:
        - IDX=cpu
        - TORCH=${TORCH_VERSION}
    - name: windows/cpu
      os: windows
      language: shell
      env:
        - IDX=cpu
        - PATH=/c/Python37:/c/Python37/Scripts:$PATH
        - TORCH=${TORCH_VERSION}+${IDX}
      before_install:
        - choco install python --version 3.7.6
        - python -m pip install --upgrade --user pip
    # - name: windows/cu92
    #   os: windows
    #   language: shell
    #   env:
    #     - FORCE_CUDA=1
    #     - CUDA_SHORT=9.2
    #     - CUDA=9.2.148
    #     - TORCH=${TORCH_VERSION}+92
    #     - PATH=/c/Python37:/c/Python37/Scripts:$PATH
    #   before_install:
    #     - choco install python --version 3.7.6
    # - name: windows/cu100
    #   os: windows
    #   language: shell
    #   env:
    #     - FORCE_CUDA=1
    #     - CUDA_SHORT=10.1
    #     - CUDA=10.0.130_411.31
    #     - TORCH=${TORCH_VERSION}+100
    #     - PATH=/c/Python37:/c/Python37/Scripts:$PATH
    #   before_install:
    #     - choco install python --version 3.7.6
    # - name: windows/cu102
    #   os: windows
    #   language: shell
    #   env:
    #     - FORCE_CUDA=1
    #     - CUDA_SHORT=10.1
    #     - CUDA=10.1.105_418.96
    #     - TORCH=${TORCH_VERSION}
    #     - PATH=/c/Python37:/c/Python37/Scripts:$PATH
    #   before_install:
    #     - choco install python --version 3.7.6

install:
  - pip3 install --upgrade pip
  - source script/install.sh
  - pip3 install numpy
  - pip3 install torch==${TORCH}+${IDX} -f https://download.pytorch.org/whl/torch_stable.html
  - pip3 install flake8
  - pip3 install codecov
  - python3 setup.py install || python setup.py install

script:
  - flake8 .
  - python3 setup.py test || python setup.py test
after_success:
  - if [ "${TRAVIS_OS_NAME}" != "windows" ]; then python3 setup.py bdist_wheel --dist-dir=dist/${IDX}; fi
  - if [ "${TRAVIS_OS_NAME}" == "windows" ]; then python setup.py bdist_wheel --dist-dir=dist/${IDX}; fi
  - codecov
deploy:
  provider: s3
  edge: true
  skip_cleanup: true
  access_key_id: AKIAIZNS6U2JRBGA3OHA
  secret_access_key: ${S3_SECRET_ACCESS_KEY}
  bucket: pytorch-scatter
  local-dir: dist/${IDX}
  upload-dir: whl/${IDX}
  acl: public_read
  on:
    repo: rusty1s/pytorch_scatter
    # tags: true
    branch: travis
notifications:
  email: false
